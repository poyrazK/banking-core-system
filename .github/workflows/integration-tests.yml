name: Integration Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  integration-tests:
    name: IT - ${{ matrix.domain }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      actions: read
      checks: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - domain: "auth"
            db: "cbs_auth_it"
          - domain: "customer"
            db: "cbs_customer_it"
          - domain: "account"
            db: "cbs_account_it"
          - domain: "transaction"
            db: "cbs_transaction_it"
          - domain: "ledger"
            db: "cbs_ledger_it"
          - domain: "loan"
            db: "cbs_loan_it"
          - domain: "deposit"
            db: "cbs_deposit_it"
          - domain: "interest"
            db: "cbs_interest_it"
          - domain: "fee"
            db: "cbs_fee_it"
          - domain: "payment"
            db: "cbs_payment_it"
          - domain: "card"
            db: "cbs_card_it"
          - domain: "fx"
            db: "cbs_fx_it"
          - domain: "notification"
            db: "cbs_notification_it"
          - domain: "reporting"
            db: "cbs_reporting_it"

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Create Module Database
        if: matrix.db != 'postgres'
        run: |
          PGPASSWORD=test psql -h localhost -U test -d postgres -c "CREATE DATABASE ${{ matrix.db }};"

      - name: Run Integration Tests
        run: |
          # Run the specific integration tests for the domain package
          mvn test -pl :cbs-application \
            -DskipTests=false \
            -Dsurefire.failIfNoSpecifiedTests=false \
            -Dit.db.url="jdbc:postgresql://localhost:5432/${{ matrix.db }}" \
            -Dit.db.username="test" \
            -Dit.db.password="test" \
            -Dtest="com.cbs.${{ matrix.domain }}.**.*IntegrationTest"

      - name: Publish IT Results
        uses: dorny/test-reporter@v2
        if: always()
        with:
          name: IT - ${{ matrix.domain }}
          path: '**/surefire-reports/TEST-*.xml'
          reporter: java-junit
