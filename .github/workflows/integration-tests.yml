name: Integration Tests

on:
  pull_request:
    branches: [ "main" ]

jobs:
  integration-tests:
    name: ${{ matrix.module }} (IT)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - module: "cbs-auth-service"
            db: "cbs_auth_it"
          - module: "cbs-customer-service"
            db: "cbs_customer_it"
          - module: "cbs-account-service"
            db: "cbs_account_it"
          - module: "cbs-transaction-service"
            db: "cbs_transaction_it"
          - module: "cbs-ledger-service"
            db: "cbs_ledger_it"
          - module: "cbs-loan-service"
            db: "cbs_loan_it"
          - module: "cbs-deposit-service"
            db: "cbs_deposit_it"
          - module: "cbs-interest-service"
            db: "cbs_interest_it"
          - module: "cbs-fee-service"
            db: "cbs_fee_it"
          - module: "cbs-payment-service"
            db: "cbs_payment_it"
          - module: "cbs-card-service"
            db: "cbs_card_it"
          - module: "cbs-fx-service"
            db: "cbs_fx_it"
          - module: "cbs-notification-service"
            db: "cbs_notification_it"
          - module: "cbs-reporting-service"
            db: "cbs_reporting_it"


    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Create Module Database
        if: matrix.db != 'postgres'
        run: |
          PGPASSWORD=test psql -h localhost -U test -d postgres -c "CREATE DATABASE ${{ matrix.db }};"

      - name: Run Integration Tests
        run: |
          # Build parent and common first as they are needed by all modules
          mvn install -DskipTests -am -pl ${{ matrix.module }}
          
          # Run the specific integration tests for the module
          mvn test -pl ${{ matrix.module }} \
            -DskipTests=false \
            -Dsurefire.failIfNoSpecifiedTests=false \
            -Dit.db.url="jdbc:postgresql://localhost:5432/${{ matrix.db }}" \
            -Dit.db.username="test" \
            -Dit.db.password="test" \
            -Dtest="*IntegrationTest"
