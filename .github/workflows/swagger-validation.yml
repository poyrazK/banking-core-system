name: Swagger Validation

on:
  pull_request:
    branches: [ "main" ]

jobs:
  validate:
    name: ${{ matrix.module }} (Swagger)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - module: cbs-auth-service
            port: 8081
            db: cbs_auth_it
          - module: cbs-customer-service
            port: 8082
            db: cbs_customer_it
          - module: cbs-account-service
            port: 8083
            db: cbs_account_it
          - module: cbs-transaction-service
            port: 8084
            db: cbs_transaction_it
          - module: cbs-ledger-service
            port: 8085
            db: cbs_ledger_it
          - module: cbs-payment-service
            port: 8086
            db: cbs_payment_it
          - module: cbs-loan-service
            port: 8087
            db: cbs_loan_it
          - module: cbs-card-service
            port: 8088
            db: cbs_card_it
          - module: cbs-deposit-service
            port: 8089
            db: cbs_deposit_it
          - module: cbs-notification-service
            port: 8090
            db: cbs_notification_it
          - module: cbs-interest-service
            port: 8091
            db: cbs_interest_it
          - module: cbs-fee-service
            port: 8092
            db: cbs_fee_it
          - module: cbs-fx-service
            port: 8093
            db: cbs_fx_it
          - module: cbs-reporting-service
            port: 8094
            db: cbs_reporting_it

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Create Database
        run: |
          sudo apt-get update && sudo apt-get install -y postgresql-client
          PGPASSWORD=test psql -h localhost -U test -d postgres -c "CREATE DATABASE ${{ matrix.db }};"

      - name: Build and Start Service
        run: |
          mvn package -pl ${{ matrix.module }} -am -DskipTests -q
          java -jar ${{ matrix.module }}/target/*.jar \
            --server.port=${{ matrix.port }} \
            --spring.datasource.url=jdbc:postgresql://localhost:5432/${{ matrix.db }} \
            --spring.datasource.username=test \
            --spring.datasource.password=test \
            --eureka.client.enabled=false \
            --spring.cloud.config.enabled=false > service.log 2>&1 &
          
          echo "Waiting for service to start..."
          for i in {1..40}; do
            STATUS=$(curl -s http://localhost:${{ matrix.port }}/actuator/health | jq -r '.status' || echo "STARTING")
            echo "Attempt $i: Health status is $STATUS"
            if [ "$STATUS" == "UP" ]; then
              echo "Service is UP!"
              exit 0
            fi
            sleep 3
          done
          echo "Service failed to start. Logs:"
          cat service.log
          exit 1
        timeout-minutes: 5

      - name: Validate OpenAPI Spec
        run: |
          echo "Fetching OpenAPI spec from http://localhost:${{ matrix.port }}/v3/api-docs"
          STATUS=$(curl -s -o /tmp/api-docs.json -w "%{http_code}" http://localhost:${{ matrix.port }}/v3/api-docs)
          echo "HTTP Status: $STATUS"
          if [ "$STATUS" != "200" ]; then
            echo "Failed to fetch OpenAPI spec"
            cat /tmp/api-docs.json || true
            exit 1
          fi
          
          # Validate JSON structure
          jq '.' /tmp/api-docs.json
          
          # Check for title
          TITLE=$(jq -r '.info.title' /tmp/api-docs.json)
          echo "API Title: $TITLE"
          if [ "$TITLE" == "null" ]; then
            echo "Missing API title"
            exit 1
          fi
          
          # Check for paths
          PATHS_COUNT=$(jq '.paths | keys | length' /tmp/api-docs.json)
          echo "Paths count: $PATHS_COUNT"
          if [ "$PATHS_COUNT" == "0" ]; then
            echo "No paths found in OpenAPI spec"
            exit 1
          fi
